<Window
    x:Class="Sample.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:cp="clr-namespace:ColorPicker;assembly=ColorPicker"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:Sample"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    Title="MainWindow"
    Width="800"
    Height="450"
    mc:Ignorable="d">
    <StackPanel Orientation="Horizontal">
        <ComboBox
            Width="100"
            Height="24"
            VerticalAlignment="Top"
            Background="White"
            BorderBrush="DarkGray"
            ItemsSource="{Binding BaseColors}">
            <ComboBox.Style>
                <Style>
                    <Setter Property="UIElement.SnapsToDevicePixels" Value="True" />
                    <Setter Property="FrameworkElement.OverridesDefaultStyle" Value="True" />
                    <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Auto" />
                    <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto" />
                    <Setter Property="ScrollViewer.CanContentScroll" Value="True" />
                    <Setter Property="FrameworkElement.FocusVisualStyle" Value="{x:Null}" />
                    <Setter Property="Control.Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="{x:Type ComboBox}">
                                <Grid>
                                    <ToggleButton
                                        x:Name="ToggleButton"
                                        Grid.Column="2"
                                        ClickMode="Press"
                                        Focusable="False"
                                        IsChecked="{Binding IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}" />

                                    <ContentPresenter
                                        x:Name="ContentSite"
                                        Margin="5,3,23,3"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center"
                                        Content="{TemplateBinding SelectionBoxItem}"
                                        ContentTemplate="{TemplateBinding SelectionBoxItemTemplate}"
                                        ContentTemplateSelector="{TemplateBinding ItemTemplateSelector}"
                                        IsHitTestVisible="False" />

                                    <TextBox
                                        x:Name="PART_EditableTextBox"
                                        Margin="3,3,23,3"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center"
                                        Background="Transparent"
                                        Focusable="{Binding Focusable, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ComboBox}}}"
                                        Foreground="{Binding Foreground, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ComboBox}}}"
                                        IsReadOnly="{Binding IsReadOnly, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ComboBox}}}"
                                        Visibility="Hidden">

                                        <TextBox.Template>
                                            <ControlTemplate TargetType="{x:Type TextBox}">
                                                <Border x:Name="PART_ContentHost" Focusable="{Binding Focusable, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ComboBox}}}" />
                                            </ControlTemplate>
                                        </TextBox.Template>
                                    </TextBox>
                                    <!--  Popup showing items  -->
                                    <Popup
                                        x:Name="Popup"
                                        AllowsTransparency="True"
                                        Focusable="False"
                                        IsOpen="{TemplateBinding IsDropDownOpen}"
                                        Placement="Bottom"
                                        PlacementTarget="{Binding ElementName=PART_EditableTextBox}"
                                        PopupAnimation="Slide">

                                        <Border
                                            x:Name="DropDownBorder"
                                            Margin="0,1,0,0"
                                            Padding="2"
                                            Background="{Binding Background, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ComboBox}}}"
                                            BorderBrush="{Binding BorderBrush, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type ComboBox}}}"
                                            BorderThickness="1"
                                            CornerRadius="0">
                                            <cp:ColorPickerControl
                                                CurrentColor="{TemplateBinding SelectedValue}"
                                                DataContext="{Binding}"
                                                SnapsToDevicePixels="False" />
                                        </Border>
                                    </Popup>
                                </Grid>

                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsEnabled" Value="False">
                                        <Setter Property="TextElement.Foreground" Value="Gray" />
                                    </Trigger>
                                    <Trigger Property="IsGrouping" Value="True">
                                        <Setter Property="ScrollViewer.CanContentScroll" Value="False" />
                                    </Trigger>
                                    <Trigger Property="IsEditable" Value="True">
                                        <Setter Property="KeyboardNavigation.IsTabStop" Value="False" />
                                        <Setter TargetName="PART_EditableTextBox" Property="Visibility" Value="Visible" />
                                        <Setter TargetName="ContentSite" Property="Visibility" Value="Hidden" />
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ComboBox.Style>
        </ComboBox>
        <cp:ColorPickerControl CurrentColor="{Binding CurrentColor}" SelectedColorChanged="ColorPickerControl_SelectedColorChanged" />
        <Rectangle
            Name="_rect"
            Width="32"
            Height="32" />
    </StackPanel>
</Window>